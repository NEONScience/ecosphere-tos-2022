---
title: 'MEE Worked Example: Meier et al. 2022'
author: "Courtney L. Meier"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#   Load required CRAN libraries
library(devtools)
library(dplyr)
library(DT)
library(ggplot2)
library(neonUtilities)
library(plotly)
library(stringr)
library(tidyr)

##  Install and load geoNEON package from Github; required to programmatically access TOS Spatial Data
# devtools::install_github('NEONScience/NEON-geolocation/geoNEON', dependencies=TRUE)
library(geoNEON)

```


### Introduction

The NEON Terrestrial Observation System (TOS) data products are frequently spatially integrated at multiple scales, from the site level to the level of relatively small 'sampling cells' that occur within plots (see Supporting Information, Table 3). The purpose of this worked example is to illustrate this spatial integration, and to show how a data user can work with two TOS data products at different spatial scales in order to draw scientific insight. We focus on the 'Coarse downed wood log survey' data product (DP1.10010.001) and the 'Small mammal box trapping' data product (DP1.10072.001), and we show how to link data at both the plot and site spatial scales. 


### Load data from the NEON Data Portal

At sites with sufficient logs >= 2 cm diameter, the 'Coarse downed wood log survey' data product, hereafter referred to as 'CDW Tally', is generated from both Distributed and Tower plots on a 5 year interval. However, sampling of Distributed and Tower plots is staggered through time such that each plot type is sampled every 2-3 years within a site. Distributed plots are allocated across each site in proportion to the area of dominant NLCD Vegetation Classes, and these plots allow creating statistically robust site-level estimates of both CDW volume (derived from tallies), and small mammal density. The Small Mammal (MAM) data product is generated annually from the majority of TOS sites, and MAM data are collected from grids that are collocated with Distributed base plots that also support CDW sampling. Because MAM grids are not collocated with Tower plots, the first tasks for this example are to identify which NEON sites have produced CDW Tally data, identify several forested sites with recent Distributed plot data for the example, and then identify which Distributed plotIDs are collocated with MAM sampling. 

``` {r cdwLoadData, results=FALSE}
### Load CDW Tally data for last 6 years from NEON Data Portal for all sites and dates; use of a user-specific API token is not required, but can give faster download speeds from the NEON Portal
# cdwDP <- neonUtilities::loadByProduct(
#   dpID = "DP1.10010.001",
#   site = "all",
#   startdate = "2016-01",
#   enddate = "2021-12",
#   package = "basic",
#   release = "RELEASE-2022",
#   tabl = "all",
#   check.size = FALSE,
#   token = Sys.getenv('NEON_PAT')
# )
# 
# #   Extract the field tally data from the download list, and save for quicker read-in during dev --> remove saving later
# cdw <- cdwDP$cdw_fieldtally
# saveRDS(cdw, file = "cdw_fieldTally_2016-2021.RDS")

#   Read in saved data for continued dev work
cdw <- readRDS(file = "cdw_fieldTally_2016-2021.RDS")

#   Summarise data to identify 5-6 sites with recent CDW Tally data from Distributed plots that can be paired with MAM data; for demonstration purposes, goal is to choose a small number of forested sites that span a range of habitats
summaryDist <- cdw %>%
  dplyr::filter(plotType=="distributed") %>%
  dplyr::group_by(domainID, siteID, eventID, samplingImpractical) %>%
  dplyr::summarise(
    plotCount = length(unique(plotID))
  )

#   Selected sites are all predominantly forested
theSites <- c("HARV","JERC","STEI","UKFS","RMNP","ABBY")

#   Filter CDW data to selected sites, filter to most recent eventID, remove unneeded columns
tempCDW <- cdw %>%
  dplyr::filter(
    plotType=="distributed",
    siteID %in% theSites
  ) %>%
  dplyr::group_by(domainID, siteID) %>%
  dplyr::filter(
    yearBoutBegan==max(yearBoutBegan)
  ) %>%
  dplyr::arrange(domainID, siteID, plotID) %>%
  dplyr::ungroup() %>%
  dplyr::select(-uid, -coordinateUncertainty, -elevationUncertainty, -publicationDate)


##  Join CDW data with TOS Spatial Data to enable identification of Distributed base plots collocated with MAM grids
#   Retrieve TOS Named Location spatial data (i.e., TOS plot spatial data)
tosPlots <- geoNEON::getLocByName(
  data = tempCDW,
  locCol = "namedLocation",
  locOnly = TRUE
)
#--> currently returns API error for unknown reason


#   TOS Spatial Data may also be manually downloaed: https://data.neonscience.org/documents (then click on 'Spatial Data' and click on 'All_NEON_TOS_Plots_VX' link to retrieve zip that contains a .csv with plot data)
tosPlots <- read.csv(file = "All_NEON_TOS_Plot_Centroids_V8.csv", header = TRUE)

#   Create a column 'subtype' that identifies plotIDs collocated with MAM grids
tempCDW <- tempCDW %>%
  dplyr::left_join(
    tosPlots %>% 
      filter(subtype=="mammalGrid") %>% 
      select(plotID, subtype),
    by = "plotID"
  )

```


Need a section here for loading MAM data

``` {r mamLoadData, results=FALSE}


```



### Data QC Checks








